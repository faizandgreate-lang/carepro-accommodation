<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Care-Pro Riyadh Accommodation</title>
<style>
  body { font-family: "Poppins", Arial, sans-serif; margin: 20px; background: linear-gradient(135deg,#f8f9fa,#e9ecef); color:#222; }
  h1 { text-align:center; color:#004085; font-size:28px; margin-bottom:15px;}
  table{border-collapse:collapse;width:100%;margin:15px 0;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  th,td{border:1px solid #ddd;padding:8px 10px;text-align:left;font-size:14px}
  th{background:#004085;color:#fff;text-transform:uppercase}
  tr:nth-child(even){background:#f8f9fa}
  .form{border:1px solid #ccc;padding:12px;background:#fff;border-radius:8px;margin-top:10px}
  .form input{margin:5px;padding:6px 10px;border:1px solid #bbb;border-radius:4px}
  .form button{background:#004085;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin:5px}
  .hidden{display:none}
  .search-box{background:#e9f2ff;padding:12px;border-radius:8px;border:1px solid #cce5ff;margin-top:10px}
  .footer{text-align:center;margin-top:30px;color:#555;font-style:italic}
  @media (max-width:768px){table,th,td{font-size:12px}.form input,button{width:100%;display:block}}
</style>
</head>
<body>

<h1>üè† CARE-PRO ACCOMMODATION</h1>

<div>
  <span id="loginBox">
    <input type="password" id="adminPw" placeholder="Enter Admin Password">
    <button onclick="login()">Login</button>
  </span>
  <span id="adminBox" class="hidden">
    <button onclick="logout()">Logout</button>
  </span>
</div>

<div id="editor" class="form hidden">
  <h4>üîß ADMIN PANEL</h4>
  <label>IQAMA: <input id="f_iq"></label>
  <label>Name: <input id="f_name"></label>
  <label>Camp: <input id="f_camp" placeholder="CP 1 / CP 2 / CP 3"></label>
  <label>Company: <input id="f_company"></label>
  <label>Gender: <input id="f_gender"></label>
  <label>Nationality: <input id="f_nationality"></label>
  <label>Sponsor: <input id="f_sponsor"></label>
  <label>Room No: <input id="f_room"></label>
  <br>
  <button onclick="addWorker()">Add Worker</button>
  <button onclick="deleteWorkerPrompt()">Delete by IQAMA</button>
  <div id="msg" style="color:green;margin-top:8px;font-weight:600;"></div>

  <h4>üèïÔ∏è Manage Camps</h4>
  <input id="newCampName" placeholder="Enter Camp Name">
  <button onclick="addNewCamp()">Add Camp</button>
  <button onclick="deleteCamp()">Delete Camp</button>

  <h4>üì§ Export / üì• Import Workers</h4>
  <button onclick="exportCSV()">Export Workers CSV</button><br><br>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="importCSV()">Import CSV</button>
  <p style="font-size:12px;color:gray">CSV Format: iq,name,camp,company,gender,nationality,sponsor,room</p>
</div>

<h2>üèïÔ∏è Select Camp</h2>
<div style="margin:10px 0;">
  <label>Camp:
    <select id="campSelect" onchange="showSelectedCamp()"></select>
  </label>
  <button onclick="showSelectedCamp()">Show Camp</button>
</div>

<div class="search-box">
  <h3>üîç Search Worker by IQAMA</h3>
  <input type="text" id="searchIqama" placeholder="Enter IQAMA Number">
  <button onclick="searchByIqama()">Search</button>
  <div id="searchResult" style="margin-top:10px;"></div>
</div>

<h2>üè¢ Client / Company Summary</h2>
<div id="clientSummary"></div>

<h2>üèòÔ∏è Camp Summary</h2>
<div id="campSummary"></div>

<h2>üë∑ Worker Details</h2>

<!-- üîΩ FILTER ADDED HERE -->
<div class="search-box">
  <h3>‚öôÔ∏è Filter Workers</h3>
  <label>Company:
    <input type="text" id="filterCompany" placeholder="Type company name">
  </label>
  <label>Gender:
    <select id="filterGender">
      <option value="">All</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
  </label>
  <label>Nationality:
    <input type="text" id="filterNationality" placeholder="Type nationality">
  </label>
  <button onclick="applyFilter()">Filter</button>
  <button onclick="clearFilter()">Clear</button>
</div>
<!-- üîº END FILTER -->

<div id="tableWrap"></div>

<div class="footer">Made with ‚ù§Ô∏è by <span>Faizan Khan</span></div>

<script>
const ADMIN_PASSWORD = '1234';
let isAdmin = false;
let workers = [];
let camps = [];
let campData = {};

async function apiGetData() {
  try {
    const r = await fetch('/api/saveData');
    if (!r.ok) throw new Error('Failed to load data: ' + r.status);
    return await r.json();
  } catch (e) {
    console.error(e);
    alert('Error loading data from server.');
    return { workers: [], camps: [], campData: {} };
  }
}

async function apiSaveData() {
  try {
    const r = await fetch('/api/saveData', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ workers, camps, campData })
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j.message || 'Save failed');
    return j;
  } catch (e) {
    console.error(e);
    alert('Error saving data to server.');
    return null;
  }
}

/* ---------- AUTH ---------- */
function login() {
  const pw = document.getElementById('adminPw').value;
  if (pw === ADMIN_PASSWORD) {
    isAdmin = true;
    document.getElementById('editor').classList.remove('hidden');
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('adminBox').classList.remove('hidden');
    document.getElementById('msg').innerText = 'Admin mode enabled';
    renderAll();
  } else {
    alert('‚ùå Wrong password!');
  }
}
function logout() {
  isAdmin = false;
  document.getElementById('editor').classList.add('hidden');
  document.getElementById('loginBox').classList.remove('hidden');
  document.getElementById('adminBox').classList.add('hidden');
  renderAll();
}

/* ---------- CRUD ---------- */
function addWorker() {
  const w = {
    iq: f_iq.value.trim(), name: f_name.value.trim(), camp: f_camp.value.trim(),
    company: f_company.value.trim(), gender: f_gender.value.trim(),
    nationality: f_nationality.value.trim(), sponsor: f_sponsor.value.trim(),
    room: f_room.value.trim()
  };
  if (!w.iq || !w.name) return alert("IQAMA and Name required!");
  workers.push(w);
  apiSaveData().then(res => { if (res) { document.getElementById('msg').innerText = "‚úÖ Worker added!"; renderAll(); }});
}

function deleteWorkerPrompt() {
  const iq = prompt("Enter IQAMA to delete:");
  if (!iq) return;
  const idx = workers.findIndex(w => w.iq === iq);
  if (idx >= 0) {
    workers.splice(idx, 1);
    apiSaveData().then(res => { if (res) { alert("üóëÔ∏è Worker deleted!"); renderAll(); } });
  } else alert("‚ùå IQAMA not found!");
}

function addNewCamp() {
  const name = newCampName.value.trim();
  if (!name) return alert('Enter camp name.');
  if (camps.includes(name)) return alert('Duplicate camp.');
  camps.push(name);
  campData[name] = { beds: 0, rooms: 0 };
  apiSaveData().then(res => { if (res) { updateCampDropdown(); newCampName.value = ''; alert(`‚úÖ Camp "${name}" added.`); renderAll(); }});
}

function deleteCamp() {
  const name = newCampName.value.trim();
  if (!name) return alert('Enter camp name to delete.');
  if (!camps.includes(name)) return alert('Camp not found.');
  if (!confirm(`Delete camp "${name}" and its workers?`)) return;
  camps = camps.filter(c => c !== name);
  delete campData[name];
  workers = workers.filter(w => w.camp !== name);
  apiSaveData().then(res => { if (res) { updateCampDropdown(); renderAll(); alert(`üóëÔ∏è Camp "${name}" deleted.`); }});
}

/* ---------- UI ---------- */
function updateCampDropdown() {
  const select = campSelect;
  select.innerHTML = '';
  camps.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c; opt.innerText = c; select.appendChild(opt);
  });
}

function renderTable(campFilter='') {
  let html = `<table><tr><th>#</th><th>IQAMA</th><th>Name</th><th>Camp</th><th>Company</th><th>Gender</th><th>Nationality</th><th>Sponsor</th><th>Room</th></tr>`;
  let count = 1;
  workers.forEach(w => {
    if (!campFilter || w.camp === campFilter) {
      html += `<tr><td>${count++}</td><td>${w.iq}</td><td>${w.name}</td><td>${w.camp}</td><td>${w.company}</td><td>${w.gender}</td><td>${w.nationality}</td><td>${w.sponsor}</td><td>${w.room}</td></tr>`;
    }
  });
  html += '</table>';
  tableWrap.innerHTML = html;
}

/* ---------- FILTER ---------- */
function applyFilter() {
  const company = document.getElementById('filterCompany').value.trim().toLowerCase();
  const gender = document.getElementById('filterGender').value.trim().toLowerCase();
  const nationality = document.getElementById('filterNationality').value.trim().toLowerCase();

  let filtered = workers.filter(w => {
    return (!company || (w.company || '').toLowerCase().includes(company)) &&
           (!gender || (w.gender || '').toLowerCase().includes(gender)) &&
           (!nationality || (w.nationality || '').toLowerCase().includes(nationality));
  });

  renderFilteredTable(filtered);
}

function clearFilter() {
  document.getElementById('filterCompany').value = '';
  document.getElementById('filterGender').value = '';
  document.getElementById('filterNationality').value = '';
  renderTable(); // show all
}

function renderFilteredTable(filtered) {
  let html = `<table><tr><th>#</th><th>IQAMA</th><th>Name</th><th>Camp</th><th>Company</th><th>Gender</th><th>Nationality</th><th>Sponsor</th><th>Room</th></tr>`;
  let count = 1;
  filtered.forEach(w => {
    html += `<tr><td>${count++}</td><td>${w.iq}</td><td>${w.name}</td><td>${w.camp}</td><td>${w.company}</td><td>${w.gender}</td><td>${w.nationality}</td><td>${w.sponsor}</td><td>${w.room}</td></tr>`;
  });
  html += '</table>';
  tableWrap.innerHTML = html;
}

/* ---------- REST ---------- */
function renderClientSummary() {
  const map = {};
  workers.forEach(w => {
    map[w.company] = map[w.company] || {};
    map[w.company][w.camp] = (map[w.company][w.camp] || 0) + 1;
  });
  let html = '<table><tr><th>Company</th>';
  camps.forEach(c => html += `<th>${c}</th>`);
  html += '<th>Total</th></tr>';
  let total = 0;
  for (const comp in map) {
    let sum = 0; html += `<tr><td>${comp}</td>`;
    camps.forEach(c => {
      const val = map[comp][c] || 0; sum += val; html += `<td>${val}</td>`;
    });
    html += `<td>${sum}</td></tr>`; total += sum;
  }
  html += `<tr style="font-weight:bold;background:#cfe2ff;"><td>Total</td><td colspan="${Math.max(1,camps.length)}"></td><td>${total}</td></tr></table>`;
  clientSummary.innerHTML = html;
}

function renderCampSummary() {
  let html = '<table><tr><th>Camp</th><th>Rooms</th><th>Total Beds</th><th>Available Beds</th><th>Male</th><th>Female</th><th>Total</th></tr>';
  let totalWorkers = 0;
  camps.forEach(c => {
    const total = workers.filter(w => w.camp === c).length;
    const male = workers.filter(w => w.camp === c && (w.gender||'').toLowerCase().startsWith('m')).length;
    const female = workers.filter(w => w.camp === c && (w.gender||'').toLowerCase().startsWith('f')).length;
    const data = campData[c] || { beds: 0, rooms: 0 };
    const avail = Math.max(data.beds - total, 0);
    totalWorkers += total;
    html += `<tr>
      <td>${c}</td>
      <td>${isAdmin ? `<input type='number' value='${data.rooms}' onchange='updateCampRooms("${c}",this.value)'>` : data.rooms}</td>
      <td>${isAdmin ? `<input type='number' value='${data.beds}' onchange='updateCampBeds("${c}",this.value)'>` : data.beds}</td>
      <td>${avail}</td><td>${male}</td><td>${female}</td><td>${total}</td>
    </tr>`;
  });
  html += `<tr style="font-weight:bold;background:#cfe2ff;"><td colspan="6">Total Workers</td><td>${totalWorkers}</td></tr></table>`;
  campSummary.innerHTML = html;
}

/* ---------- INITIAL LOAD ---------- */
async function loadData() {
  const data = await apiGetData();
  workers = data.workers || [];
  camps = data.camps || [];
  campData = data.campData || {};
  updateCampDropdown();
  renderAll();
}

function renderAll() {
  updateCampDropdown();
  renderTable();
  renderClientSummary();
  renderCampSummary();
}

/* ---------- CAMP FILTER ---------- */
function showSelectedCamp() {
  const selected = document.getElementById('campSelect').value;
  if (selected) renderTable(selected);
  else renderTable();
}

/* ---------- CSV IMPORT / EXPORT ---------- */
function exportCSV() {
  if (workers.length === 0) return alert("No data to export!");
  const headers = ["iq","name","camp","company","gender","nationality","sponsor","room"];
  const rows = workers.map(w => headers.map(h => `"${(w[h] || "").replace(/"/g,'""')}"`).join(","));
  const csv = headers.join(",") + "\n" + rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "workers.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function importCSV() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Please select a CSV file first!");
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split("\n").map(l => l.trim()).filter(l => l);
    const headers = lines.shift().split(",").map(h => h.trim().replace(/"/g,""));
    const newWorkers = lines.map(line => {
      const values = line.split(",").map(v => v.replace(/^"|"$/g,"").trim());
      const w = {};
      headers.forEach((h,i)=>w[h]=values[i]||"");
      return w;
    });
    if (confirm(`Import ${newWorkers.length} workers? This will replace current list.`)) {
      workers = newWorkers;
      apiSaveData().then(res=>{if(res){alert("‚úÖ CSV Imported Successfully!");renderAll();}});
    }
  };
  reader.readAsText(file);
}

loadData();
</script>
</body>
</html>
