<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Care-Pro Riyadh Accommodation</title>
<style>
  body { font-family: "Poppins", Arial, sans-serif; margin: 20px; background: linear-gradient(135deg,#f8f9fa,#e9ecef); color:#222; }
  h1 { text-align:center; color:#004085; font-size:28px; margin-bottom:15px;}
  table{border-collapse:collapse;width:100%;margin:15px 0;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  th,td{border:1px solid #ddd;padding:8px 10px;text-align:left;font-size:14px;position:relative;}
  th{background:#004085;color:#fff;text-transform:uppercase;cursor:pointer;}
  tr:nth-child(even){background:#f8f9fa}
  .form{border:1px solid #ccc;padding:12px;background:#fff;border-radius:8px;margin-top:10px}
  .form input{margin:5px;padding:6px 10px;border:1px solid #bbb;border-radius:4px}
  .form button{background:#004085;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin:5px}
  .hidden{display:none}
  .footer{text-align:center;margin-top:30px;color:#555;font-style:italic}
  .dropdown { display:none; position:absolute; background:#fff; border:1px solid #ccc; border-radius:4px; top:100%; left:0; z-index:10; padding:5px; max-height:200px; overflow:auto; width:150px; box-shadow:0 2px 6px rgba(0,0,0,.1);}
  .dropdown label { display:block; font-size:13px; cursor:pointer; margin:3px 0; }
  .filter-arrow::after { content:"‚ñº"; font-size:10px; margin-left:6px; color:#fff; }
  @media (max-width:768px){table,th,td{font-size:12px}.form input,button{width:100%;display:block}}
</style>
</head>
<body>

<h1>üè† CARE-PRO ACCOMMODATION</h1>

<div>
  <span id="loginBox">
    <input type="password" id="adminPw" placeholder="Enter Admin Password">
    <button onclick="login()">Login</button>
  </span>
  <span id="adminBox" class="hidden">
    <button onclick="logout()">Logout</button>
  </span>
</div>

<div id="editor" class="form hidden">
  <h4>üîß ADMIN PANEL</h4>
  <label>IQAMA: <input id="f_iq"></label>
  <label>Name: <input id="f_name"></label>
  <label>Camp: <input id="f_camp" placeholder="CP 1 / CP 2 / CP 3"></label>
  <label>Company: <input id="f_company"></label>
  <label>Gender: <input id="f_gender"></label>
  <label>Nationality: <input id="f_nationality"></label>
  <label>Sponsor: <input id="f_sponsor"></label>
  <label>Room No: <input id="f_room"></label>
  <br>
  <button onclick="addWorker()">Add Worker</button>
  <button onclick="deleteWorkerPrompt()">Delete by IQAMA</button>
  <div id="msg" style="color:green;margin-top:8px;font-weight:600;"></div>

  <h4>üèïÔ∏è Manage Camps</h4>
  <input id="newCampName" placeholder="Enter Camp Name">
  <button onclick="addNewCamp()">Add Camp</button>
  <button onclick="deleteCamp()">Delete Camp</button>

  <h4>üì§ Export / üì• Import Workers</h4>
  <button onclick="exportCSV()">Export Workers CSV</button><br><br>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="importCSV()">Import CSV</button>
  <p style="font-size:12px;color:gray">CSV Format: iq,name,camp,company,gender,nationality,sponsor,room</p>
</div>

<h2>üèïÔ∏è Select Camp</h2>
<div style="margin:10px 0;">
  <label>Camp:
    <select id="campSelect" onchange="showSelectedCamp()"></select>
  </label>
  <button onclick="showSelectedCamp()">Show Camp</button>
</div>

<div class="search-box">
  <h3>üîç Search Worker by IQAMA</h3>
  <input type="text" id="searchIqama" placeholder="Enter IQAMA Number">
  <button onclick="searchByIqama()">Search</button>
  <div id="searchResult" style="margin-top:10px;"></div>
</div>

<h2>üè¢ Client / Company Summary</h2>
<div id="clientSummary"></div>

<h2>üèòÔ∏è Camp Summary</h2>
<div id="campSummary"></div>

<h2>üë∑ Worker Details</h2>
<div id="tableWrap"></div>

<div class="footer">Made with ‚ù§Ô∏è by <span>Faizan Khan</span></div>

<script>
const ADMIN_PASSWORD = '12341234';
let isAdmin = false;
let workers = [];
let camps = [];
let campData = {}; // persistent storage object (will store rooms,beds,meta and headers)
let activeFilters = {}; // store selected filters

async function apiGetData() {
  try {
    const r = await fetch('/api/saveData');
    if (!r.ok) throw new Error('Failed to load data');
    return await r.json();
  } catch (e) {
    console.error(e); alert('Error loading data.');
    return { workers: [], camps: [], campData: {} };
  }
}
async function apiSaveData() {
  try {
    const r = await fetch('/api/saveData', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({workers,camps,campData})});
    const j = await r.json();
    if (!r.ok) throw new Error(j.message||'Save failed');
    return j;
  } catch(e){console.error(e);alert('Error saving data');return null;}
}

function login(){if(adminPw.value===ADMIN_PASSWORD){isAdmin=true;editor.classList.remove('hidden');loginBox.classList.add('hidden');adminBox.classList.remove('hidden');msg.innerText='Admin mode enabled';renderAll();}else alert('‚ùå Wrong password!');}
function logout(){isAdmin=false;editor.classList.add('hidden');loginBox.classList.remove('hidden');adminBox.classList.add('hidden');renderAll();}

function addWorker(){const w={iq:f_iq.value.trim(),name:f_name.value.trim(),camp:f_camp.value.trim(),company:f_company.value.trim(),gender:f_gender.value.trim(),nationality:f_nationality.value.trim(),sponsor:f_sponsor.value.trim(),room:f_room.value.trim()};if(!w.iq||!w.name)return alert("IQAMA and Name required!");workers.push(w);apiSaveData().then(r=>{if(r){msg.innerText="‚úÖ Worker added!";renderAll();}});}
function deleteWorkerPrompt(){const iq=prompt("Enter IQAMA to delete:");if(!iq)return;const i=workers.findIndex(w=>w.iq===iq);if(i>=0){workers.splice(i,1);apiSaveData().then(r=>{if(r){alert("üóëÔ∏è Worker deleted!");renderAll();}});}else alert("‚ùå IQAMA not found!");}
function addNewCamp(){const n=newCampName.value.trim();if(!n)return alert('Enter camp name.');if(camps.includes(n))return alert('Duplicate camp.');camps.push(n);campData[n]=campData[n]||{beds:0,rooms:0,meta:{}};apiSaveData().then(r=>{if(r){updateCampDropdown();newCampName.value='';alert(`‚úÖ Camp "${n}" added.`);renderAll();}});}
function deleteCamp(){const n=newCampName.value.trim();if(!n)return alert('Enter camp name to delete.');if(!camps.includes(n))return alert('Camp not found.');if(!confirm(`Delete camp "${n}"?`))return;camps=camps.filter(c=>c!==n);delete campData[n];workers=workers.filter(w=>w.camp!==n);apiSaveData().then(r=>{if(r){updateCampDropdown();renderAll();alert(`üóëÔ∏è Camp "${n}" deleted.`);}});}

function updateCampDropdown(){campSelect.innerHTML='';camps.forEach(c=>{const o=document.createElement('option');o.value=c;o.innerText=c;campSelect.appendChild(o);});}

function renderTable(campFilter=''){
  let filtered = workers.filter(w => (!campFilter || w.camp === campFilter));
  Object.keys(activeFilters).forEach(k=>{
    if(activeFilters[k].length>0){
      filtered = filtered.filter(w => activeFilters[k].includes((w[k]||'').toString()));
    }
  });

  let html = `<table><thead><tr>
    <th>#</th><th>IQAMA</th><th>Name</th>
    <th class='filter-arrow' onclick="toggleDropdown('camp')">Camp<div id='drop-camp' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('company')">Company<div id='drop-company' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('gender')">Gender<div id='drop-gender' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('nationality')">Nationality<div id='drop-nationality' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('sponsor')">Sponsor<div id='drop-sponsor' class='dropdown'></div></th>
    <th>Room</th></tr></thead><tbody>`;

  let count=1;
  filtered.forEach(w=>{
    html += `<tr><td>${count++}</td><td>${w.iq}</td><td>${w.name}</td><td>${w.camp}</td><td>${w.company}</td><td>${w.gender}</td><td>${w.nationality}</td><td>${w.sponsor}</td><td>${w.room}</td></tr>`;
  });
  html += '</tbody></table>';
  tableWrap.innerHTML = html;
  buildDropdowns();
}

function buildDropdowns(){
  ['camp','company','gender','nationality','sponsor'].forEach(k=>{
    const values = [...new Set(workers.map(w=>(w[k]||'').trim()).filter(v=>v))].sort();
    const drop = document.getElementById('drop-'+k);
    if(!drop) return;
    drop.innerHTML = `<label><input type='checkbox' value='' onchange='filterChange("${k}", this)'> All</label>`;
    values.forEach(v=>{
      const checked = activeFilters[k]?.includes(v) ? 'checked' : '';
      drop.innerHTML += `<label><input type='checkbox' value='${v}' ${checked} onchange='filterChange("${k}", this)'> ${v}</label>`;
    });
  });
}

function toggleDropdown(k){
  const el = document.getElementById('drop-'+k);
  const all = document.querySelectorAll('.dropdown');
  all.forEach(d=>{if(d!==el)d.style.display='none';});
  el.style.display = el.style.display==='block'?'none':'block';
}
window.onclick=function(e){if(!e.target.closest('th'))document.querySelectorAll('.dropdown').forEach(d=>d.style.display='none');};

function filterChange(k, el){
  const val = el.value;
  activeFilters[k] = activeFilters[k] || [];
  if(val===''){activeFilters[k]=[];renderTable();}
  else{
    if(el.checked) activeFilters[k].push(val);
    else activeFilters[k]=activeFilters[k].filter(v=>v!==val);
    renderTable();
  }
}

function renderClientSummary(){
  const map={};
  workers.forEach(w=>{map[w.company]=map[w.company]||{};map[w.company][w.camp]=(map[w.company][w.camp]||0)+1;});
  let html='<table><tr><th>Company</th>';
  camps.forEach(c=>html+=`<th>${c}</th>`);html+='<th>Total</th></tr>';
  let total=0;
  for(const comp in map){let sum=0;html+=`<tr><td>${comp}</td>`;
    camps.forEach(c=>{const val=map[comp][c]||0;sum+=val;html+=`<td>${val}</td>`;});
    html+=`<td>${sum}</td></tr>`;total+=sum;}
  html+=`<tr style="font-weight:bold;background:#cfe2ff;"><td>Total</td><td colspan="${Math.max(1,camps.length)}"></td><td>${total}</td></tr></table>`;
  clientSummary.innerHTML=html;
}

// ---------- Enhanced Camp Summary (editable, add/delete rows/columns, headings editable) ----------
function getSavedHeaders(){
  // headers saved in campData.__summaryHeaders (if exists)
  return (campData && Array.isArray(campData.__summaryHeaders) && campData.__summaryHeaders.length>0)
    ? campData.__summaryHeaders.slice()
    : ['Camp','Rooms','Total Beds','Available Beds','Male','Female','Total'];
}

function renderCampSummary(){
  const headers = getSavedHeaders();
  // build table
  let html = '<table id="campSummaryTable"><thead><tr>';
  headers.forEach(h=>{
    // headings editable in admin mode
    html += `<th ${isAdmin ? 'contenteditable="true"' : ''}>${h}</th>`;
  });
  html += '</tr></thead><tbody>';
  // rows for existing camps (in saved order)
  let totalWorkers = 0;
  camps.forEach(c=>{
    const total = workers.filter(w=>w.camp===c).length;
    const male = workers.filter(w=>w.camp===c && (w.gender||'').toLowerCase().startsWith('m')).length;
    const female = workers.filter(w=>w.camp===c && (w.gender||'').toLowerCase().startsWith('f')).length;
    const data = campData[c] || {beds:0,rooms:0,meta:{}};
    const avail = Math.max((Number(data.beds)||0) - total, 0);
    totalWorkers += total;

    html += '<tr>';
    headers.forEach(h=>{
      const key = h.trim().toLowerCase();
      let cellValue = '';
      if(key === 'camp'){
        cellValue = c;
      } else if(key === 'rooms' || key === 'room'){
        cellValue = data.rooms || 0;
      } else if(key === 'total beds' || key === 'beds' || key === 'total_beds'){
        cellValue = data.beds || 0;
      } else if(key === 'available beds' || key === 'available'){
        cellValue = avail;
      } else if(key === 'male'){
        cellValue = male;
      } else if(key === 'female'){
        cellValue = female;
      } else if(key === 'total'){
        cellValue = total;
      } else {
        // other custom columns stored under meta
        cellValue = (data.meta && data.meta[h]) !== undefined ? data.meta[h] : '';
      }
      // make editable when admin
      html += `<td ${isAdmin ? 'contenteditable="true"' : ''}>${cellValue}</td>`;
    });
    html += '</tr>';
  });

  // total row
  html += `<tr style="font-weight:bold;background:#cfe2ff;"><td colspan="${Math.max(1, headers.length-1)}">Total Workers</td><td>${totalWorkers}</td></tr>`;

  html += '</tbody></table>';

  if(isAdmin){
    html += `
      <div style="margin-top:8px;">
        <button onclick="addRow()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">‚ûï Add Row</button>
        <button onclick="deleteRow()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">üóë Delete Row</button>
        <button onclick="addColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">‚ûï Add Column</button>
        <button onclick="deleteColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">üóë Delete Column</button>
        <button onclick="saveCampSummary()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">üíæ Save Changes</button>
      </div>
    `;
  }

  campSummary.innerHTML = html;
}

function addRow(){
  const tbl = document.getElementById('campSummaryTable');
  if(!tbl) return;
  const tbody = tbl.tBodies[0] || tbl.appendChild(document.createElement('tbody'));
  const headers = tbl.tHead.rows[0].cells.length;
  // insert before the final "Total Workers" row if exists, otherwise at end
  // Find index to insert: tbody.rows.length - 1 if last row is total row, else tbody.rows.length
  let insertIndex = tbody.rows.length;
  if(tbody.rows.length>0){
    const last = tbody.rows[tbody.rows.length - 1];
    if(last && last.style && last.style.background && last.innerText.includes('Total Workers')){
      insertIndex = tbody.rows.length - 1;
    }
  }
  const row = tbody.insertRow(insertIndex);
  for(let i=0;i<headers;i++){
    const cell = row.insertCell(i);
    cell.contentEditable = "true";
    cell.innerText = (i===0 ? 'New Camp' : '');
  }
}

function deleteRow(){
  const tbl = document.getElementById('campSummaryTable');
  if(!tbl) return;
  const tbody = tbl.tBodies[0];
  if(!tbody) return;
  // do not delete if no data rows or only total row remains
  // identify total row (last row with 'Total Workers' in first cell)
  let totalRowIndex = -1;
  for(let i=0;i<tbody.rows.length;i++){
    if(tbody.rows[i] && tbody.rows[i].innerText.includes('Total Workers')){
      totalRowIndex = i;
      break;
    }
  }
  // safe to delete a data row if there is at least one data row before total row
  const dataRowCount = totalRowIndex === -1 ? tbody.rows.length : Math.max(0, totalRowIndex);
  if(dataRowCount <= 1) { alert('Cannot delete last row.'); return; }
  // delete the last data row (row before total row)
  const deleteIndex = (totalRowIndex === -1) ? tbody.rows.length - 1 : totalRowIndex - 1;
  tbody.deleteRow(deleteIndex);
}

function addColumn(){
  const tbl = document.getElementById('campSummaryTable');
  if(!tbl) return;
  const rows = tbl.rows;
  const colIndex = rows[0].cells.length; // append at end
  // add header cell
  const th = document.createElement('th');
  th.contentEditable = "true";
  th.innerText = 'New Column';
  rows[0].appendChild(th);
  // for every body row, add a new cell before the total row if present
  const tbody = tbl.tBodies[0];
  if(!tbody) return;
  for(let r=0; r<tbody.rows.length; r++){
    const row = tbody.rows[r];
    const cell = row.insertCell(row.cells.length); // append
    cell.contentEditable = "true";
    cell.innerText = (r === tbody.rows.length - 1 && row.innerText.includes('Total Workers')) ? '' : '';
  }
}

function deleteColumn(){
  const tbl = document.getElementById('campSummaryTable');
  if(!tbl) return;
  const colCount = tbl.rows[0].cells.length;
  if(colCount <= 2) { alert('Cannot delete last column.'); return; } // keep at least 2 columns
  // remove last column from header and all rows
  for(let r=0; r<tbl.rows.length; r++){
    const row = tbl.rows[r];
    if(row.cells.length > 0) row.deleteCell(row.cells.length - 1);
  }
}

function saveCampSummary(){
  const tbl = document.getElementById('campSummaryTable');
  if(!tbl) return alert('Nothing to save.');
  const headers = [];
  const thcells = tbl.tHead.rows[0].cells;
  for(let i=0;i<thcells.length;i++){
    headers.push(thcells[i].innerText.trim() || `Col${i}`);
  }
  // read rows (tbody) up to the "Total Workers" row (ignore the final total row)
  const tbody = tbl.tBodies[0];
  if(!tbody) return alert('No table body.');
  const rows = [];
  for(let r=0; r<tbody.rows.length; r++){
    const row = tbody.rows[r];
    if(row.innerText.includes('Total Workers')) break; // stop before summary row
    const cells = [];
    for(let c=0;c<row.cells.length;c++){
      cells.push(row.cells[c].innerText.trim());
    }
    // skip rows without any meaningful camp name
    if((cells[0]||'').trim() === '') continue;
    rows.push(cells);
  }

  // Build new camps list and campData entries
  const newCamps = [];
  const newCampData = {};
  rows.forEach(cells=>{
    const name = cells[0].trim();
    if(!name) return;
    newCamps.push(name);
    const existing = campData[name] || {beds:0,rooms:0,meta:{}};
    const entry = { beds: Number(existing.beds) || 0, rooms: Number(existing.rooms) || 0, meta: Object.assign({}, existing.meta || {}) };
    // assign cells to headers
    for(let i=1;i<headers.length;i++){
      const h = headers[i].trim();
      const val = cells[i] !== undefined ? cells[i] : '';
      const key = h.toLowerCase();
      // map common column names to rooms/beds
      if(key === 'rooms' || key === 'room') {
        entry.rooms = Number(val) || 0;
      } else if(key === 'total beds' || key === 'beds' || key === 'total_beds') {
        entry.beds = Number(val) || 0;
      } else {
        // save custom columns under meta by header text (preserve original header spelling)
        entry.meta[h] = val;
      }
    }
    newCampData[name] = entry;
  });

  // persist headers in campData.__summaryHeaders so headings survive refresh
  newCampData.__summaryHeaders = headers;

  // Update global vars and save
  camps = newCamps;
  // merge existing campData for any camps not in list? We'll replace campData with union of newCampData and keep non-camp helper keys if any
  // Keep any other keys in campData that aren't per-camp names (except __summaryHeaders handled above)
  const preserved = {};
  for(const k in campData){
    if(!newCampData[k] && k !== '__summaryHeaders') preserved[k] = campData[k];
  }
  campData = Object.assign({}, preserved, newCampData);
  // ensure __summaryHeaders stored at top-level
  campData.__summaryHeaders = headers;

  apiSaveData().then(res=>{
    if(res){
      alert('‚úÖ Camp summary saved.');
      // refresh dropdown and tables
      updateCampDropdown();
      renderAll();
    } else {
      alert('‚ö†Ô∏è Save failed.');
    }
  });
}

// ---------- end enhanced camp summary ----------

async function loadData(){const d=await apiGetData();workers=d.workers||[];camps=d.camps||[];campData=d.campData||{};updateCampDropdown();renderAll();}
function renderAll(){updateCampDropdown();renderTable();renderClientSummary();renderCampSummary();}
function showSelectedCamp(){const s=campSelect.value;if(s)renderTable(s);else renderTable();}

function exportCSV(){if(workers.length===0)return alert("No data to export!");const h=["iq","name","camp","company","gender","nationality","sponsor","room"];const r=workers.map(w=>h.map(x=>`"${(w[x]||"").replace(/"/g,'""')}"`).join(","));const csv=h.join(",")+"\n"+r.join("\n");const b=new Blob([csv],{type:"text/csv"});const u=URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download="workers.csv";a.click();URL.revokeObjectURL(u);}
function importCSV(){const f=document.getElementById("csvFile").files[0];if(!f)return alert("Select CSV file!");const r=new FileReader();r.onload=function(e){const lines=e.target.result.split("\n").map(l=>l.trim()).filter(l=>l);const headers=lines.shift().split(",").map(h=>h.trim().replace(/"/g,""));const nw=lines.map(l=>{const v=l.split(",").map(x=>x.replace(/^"|"$/g,"").trim());const o={};headers.forEach((h,i)=>o[h]=v[i]||"");return o;});if(confirm(`Import ${nw.length} workers?`)){workers=nw;apiSaveData().then(x=>{if(x){alert("‚úÖ CSV Imported!");renderAll();}});}};r.readAsText(f);}

// initial load
loadData();
</script>
</body>
</html>
