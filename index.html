<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Care-Pro Riyadh Accommodation</title>
<style>
  body { font-family: "Poppins", Arial, sans-serif; margin: 20px; background: linear-gradient(135deg,#f8f9fa,#e9ecef); color:#222; }
  h1 { text-align:center; color:#004085; font-size:28px; margin-bottom:15px;}
  table{border-collapse:collapse;width:100%;margin:15px 0;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  th,td{border:1px solid #ddd;padding:8px 10px;text-align:left;font-size:14px;position:relative;}
  th{background:#004085;color:#fff;text-transform:uppercase;cursor:pointer;}
  tr:nth-child(even){background:#f8f9fa}
  .form{border:1px solid #ccc;padding:12px;background:#fff;border-radius:8px;margin-top:10px}
  .form input{margin:5px;padding:6px 10px;border:1px solid #bbb;border-radius:4px}
  .form button{background:#004085;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin:5px}
  .hidden{display:none}
  .footer{text-align:center;margin-top:30px;color:#555;font-style:italic}
  .dropdown { display:none; position:absolute; background:#fff; border:1px solid #ccc; border-radius:4px; top:100%; left:0; z-index:10; padding:5px; max-height:200px; overflow:auto; width:150px; box-shadow:0 2px 6px rgba(0,0,0,.1);}
  .dropdown label { display:block; font-size:13px; cursor:pointer; margin:3px 0; }
  .filter-arrow::after { content:"▼"; font-size:10px; margin-left:6px; color:#fff; }
  @media (max-width:768px){table,th,td{font-size:12px}.form input,button{width:100%;display:block}}
</style>
</head>
<body>

<h1>🏠 CARE-PRO ACCOMMODATION</h1>

<div>
  <span id="loginBox">
    <input type="password" id="adminPw" placeholder="Enter Admin Password">
    <button onclick="login()">Login</button>
  </span>
  <span id="adminBox" class="hidden">
    <button onclick="logout()">Logout</button>
  </span>
</div>

<div id="editor" class="form hidden">
  <h4>🔧 ADMIN PANEL</h4>
  <label>IQAMA: <input id="f_iq"></label>
  <label>Name: <input id="f_name"></label>
  <label>Camp: <input id="f_camp" placeholder="CP 1 / CP 2 / CP 3"></label>
  <label>Company: <input id="f_company"></label>
  <label>Gender: <input id="f_gender"></label>
  <label>Nationality: <input id="f_nationality"></label>
  <label>Sponsor: <input id="f_sponsor"></label>
  <label>Room No: <input id="f_room"></label>
  <br>
  <button onclick="addWorker()">Add Worker</button>
  <button onclick="deleteWorkerPrompt()">Delete by IQAMA</button>
  <div id="msg" style="color:green;margin-top:8px;font-weight:600;"></div>

  <h4>🏕️ Manage Camps</h4>
  <input id="newCampName" placeholder="Enter Camp Name">
  <button onclick="addNewCamp()">Add Camp</button>
  <button onclick="deleteCamp()">Delete Camp</button>

  <h4>📤 Export / 📥 Import Workers</h4>
  <button onclick="exportCSV()">Export Workers CSV</button><br><br>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="importCSV()">Import CSV</button>
  <p style="font-size:12px;color:gray">CSV Format: iq,name,camp,company,gender,nationality,sponsor,room</p>
</div>

<h2>🏕️ Select Camp</h2>
<div style="margin:10px 0;">
  <label>Camp:
    <select id="campSelect" onchange="showSelectedCamp()"></select>
  </label>
  <button onclick="showSelectedCamp()">Show Camp</button>
</div>

<div class="search-box">
  <h3>🔍 Search Worker by IQAMA</h3>
  <input type="text" id="searchIqama" placeholder="Enter IQAMA Number">
  <button onclick="searchByIqama()">Search</button>
  <div id="searchResult" style="margin-top:10px;"></div>
</div>

<h2>🏢 Client / Company Summary</h2>
<div id="clientSummary"></div>

<h2>🏘️ Camp Summary</h2>
<div id="campSummary"></div>

<h2>👷 Worker Details</h2>
<div id="tableWrap"></div>
<div id="workerButtons" class="hidden" style="margin-bottom:15px;">
  <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">➕ Add Column</button>
  <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">🗑 Delete Column</button>
  <button onclick="saveWorkerDetails()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">💾 Save Changes</button>
</div>

<div class="footer">Made with ❤️ by <span>Faizan Khan</span></div>

<script>
const ADMIN_PASSWORD = '12341234';
let isAdmin = false;
let workers = [];
let workerHeaders = ['IQAMA','Name','Camp','Company','Gender','Nationality','Sponsor','Room'];
let camps = [];
let campData = {};
let activeFilters = {};

async function apiGetData() {
  try {
    const r = await fetch('/api/saveData');
    if (!r.ok) throw new Error('Failed to load data');
    return await r.json();
  } catch (e) {
    console.error(e); alert('Error loading data.');
    return { workers: [], camps: [], campData: {}, workerHeaders: workerHeaders };
  }
}
async function apiSaveData() {
  try {
    const r = await fetch('/api/saveData', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({workers,camps,campData,workerHeaders})});
    const j = await r.json();
    if (!r.ok) throw new Error(j.message||'Save failed');
    return j;
  } catch(e){console.error(e);alert('Error saving data');return null;}
}

function login(){
  if(adminPw.value===ADMIN_PASSWORD){
    isAdmin=true;
    editor.classList.remove('hidden');
    loginBox.classList.add('hidden');
    adminBox.classList.remove('hidden');
    document.getElementById('workerButtons').classList.remove('hidden');
    msg.innerText='Admin mode enabled';
    renderAll();
  } else alert('❌ Wrong password!');
}
function logout(){
  isAdmin=false;
  editor.classList.add('hidden');
  loginBox.classList.remove('hidden');
  adminBox.classList.add('hidden');
  document.getElementById('workerButtons').classList.add('hidden');
  renderAll();
}

function addWorker(){ 
  const w = {};
  workerHeaders.forEach(h=>{
    const key = h.toLowerCase();
    const elId = 'f_'+key.replace(/\s/g,'_');
    const val = document.getElementById(elId)?.value || '';
    w[h] = val;
  });
  if(!w['IQAMA'] || !w['Name']) return alert("IQAMA and Name required!");
  workers.push(w);
  apiSaveData().then(r=>{if(r){msg.innerText="✅ Worker added!";renderAll();}});
}

function renderWorkerTable(){
  if(!workerHeaders || workerHeaders.length==0) return;
  let html='<table id="workerTable"><thead><tr>';
  workerHeaders.forEach(h=>{
    html+=`<th ${isAdmin ? 'contenteditable="true"' : ''}>${h}</th>`;
  });
  html+='</tr></thead><tbody>';
  workers.forEach((w,index)=>{
    html+='<tr>';
    workerHeaders.forEach(h=>{
      html+=`<td ${isAdmin ? 'contenteditable="true"' : ''}>${w[h]||''}</td>`;
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=html;
}

function addWorkerColumn(){
  const name = prompt("Enter new column name:");
  if(!name) return;
  workerHeaders.push(name);
  workers.forEach(w=>w[name]='');
  renderWorkerTable();
}

function deleteWorkerColumn(){
  if(workerHeaders.length<=2){ alert("Cannot delete mandatory columns"); return; }
  const name = prompt("Enter column name to delete:");
  if(!name || !workerHeaders.includes(name)) return alert("Column not found");
  if(['IQAMA','Name'].includes(name)) return alert("Cannot delete mandatory columns");
  workerHeaders = workerHeaders.filter(h=>h!==name);
  workers.forEach(w=>delete w[name]);
  renderWorkerTable();
}

function saveWorkerDetails(){
  const tbl = document.getElementById('workerTable');
  if(!tbl) return alert('No table to save');
  const ths = tbl.tHead.rows[0].cells;
  workerHeaders = [];
  for(let i=0;i<ths.length;i++){
    workerHeaders.push(ths[i].innerText.trim() || `Col${i}`);
  }
  const trs = tbl.tBodies[0].rows;
  for(let r=0;r<trs.length;r++){
    const row = trs[r];
    workerHeaders.forEach((h,c)=>{
      workers[r][h]=row.cells[c].innerText.trim();
    });
  }
  apiSaveData().then(res=>{
    if(res) alert("✅ Worker details saved permanently");
    else alert("⚠️ Save failed");
  });
}

// ----- Load and render -----
async function loadData(){
  const d = await apiGetData();
  workers = d.workers || [];
  workerHeaders = d.workerHeaders || workerHeaders;
  camps = d.camps || [];
  campData = d.campData || {};
  renderAll();
}

function renderAll(){
  updateCampDropdown();
  renderWorkerTable();
  renderClientSummary();
  renderCampSummary();
}

function updateCampDropdown(){campSelect.innerHTML='';camps.forEach(c=>{const o=document.createElement('option');o.value=c;o.innerText=c;campSelect.appendChild(o);});}
function showSelectedCamp(){const s=campSelect.value;if(s)renderTable(s);else renderTable();}

// ---- Original functions for filtering, client/camp summary etc. remain unchanged ----

loadData();
</script>
</body>
</html>
