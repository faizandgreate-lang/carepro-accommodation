<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Care-Pro Riyadh Accommodation</title>

<style>
  body {
    font-family: "Poppins", Arial, sans-serif;
    margin: 20px;
    background: linear-gradient(135deg,#f8f9fa,#e9ecef);
    color:#222;
  }
  h1 {
    text-align:center;
    color:#004085;
    font-size:28px;
    margin-bottom:15px;
  }
  table {
    border-collapse:collapse;
    width:100%;
    margin:15px 0;
    background:#fff;
    border-radius:6px;
    overflow:hidden;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
  }
  th,td {
    border:1px solid #ddd;
    padding:8px 10px;
    text-align:left;
    font-size:14px;
    position:relative;
  }
  th {
    background:#004085;
    color:#fff;
    text-transform:uppercase;
    cursor:pointer;
  }
  tr:nth-child(even){background:#f8f9fa}
  .form {
    border:1px solid #ccc;
    padding:12px;
    background:#fff;
    border-radius:8px;
    margin-top:10px;
  }
  .form input {
    margin:5px;
    padding:6px 10px;
    border:1px solid #bbb;
    border-radius:4px;
  }
  .form button {
    background:#004085;
    color:#fff;
    border:none;
    padding:6px 10px;
    border-radius:4px;
    cursor:pointer;
    margin:5px;
  }
  .hidden{display:none}
  .footer{
    text-align:center;
    margin-top:30px;
    color:#555;
    font-style:italic;
  }
  .dropdown{
    display:none;
    position:absolute;
    background:#fff;
    border:1px solid #ccc;
    border-radius:4px;
    top:100%;left:0;z-index:10;
    padding:5px;
    max-height:200px;
    overflow:auto;
    width:150px;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
  }
  .dropdown label{
    display:block;
    font-size:13px;
    cursor:pointer;
    margin:3px 0;
  }
  .filter-arrow::after{
    content:"â–¼";
    font-size:10px;
    margin-left:6px;
    color:#fff;
  }
  @media(max-width:768px){
    table,th,td{font-size:12px}
    .form input,button{width:100%;display:block}
  }
  .summary-chart{
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    align-items:flex-start;
  }
  .summary-chart>.box{
    flex:1;
    min-width:300px;
    background:transparent;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ğŸ  CARE-PRO ACCOMMODATION</h1>

<div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
  <!-- Admin login -->
  <span id="loginBox">
    <input type="password" id="adminPw" placeholder="Enter Admin Password">
    <button onclick="login()">Login</button>
  </span>
  <span id="adminBox" class="hidden">
    <button onclick="logout()">Logout</button>
  </span>

  <!-- Make CV button -->
  <a href="https://linux-aios.github.io/care-pro-cv-generator-by-faizan/" target="_blank">
    <button style="background:#198754;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">
      Make CV
    </button>
  </a>
</div>

<div id="editor" class="form hidden">
  <h4>ğŸ”§ ADMIN PANEL</h4>

  <h4>â• Add Worker Column</h4>
  <label>Column Name:
    <input type="text" id="newWorkerColName" placeholder="Enter column name">
  </label>
  <button onclick="addCustomWorkerColumn()">Add Column</button>
  <div id="newColMsg" style="color:green;margin-top:5px;font-weight:600;"></div>

  <label>IQAMA:<input id="f_iq"></label>
  <label>Name:<input id="f_name"></label>
  <label>Camp:<input id="f_camp" placeholder="CP 1 / CP 2 / CP 3"></label>
  <label>Company:<input id="f_company"></label>
  <label>Gender:<input id="f_gender"></label>
  <label>Nationality:<input id="f_nationality"></label>
  <label>Sponsor:<input id="f_sponsor"></label>
  <label>Room No:<input id="f_room"></label>
  <br>
  <button onclick="addWorker()">Add Worker</button>
  <button onclick="deleteWorkerPrompt()">Delete by IQAMA</button>
  <div id="msg" style="color:green;margin-top:8px;font-weight:600;"></div>

  <h4>ğŸ•ï¸ Manage Camps</h4>
  <input id="newCampName" placeholder="Enter Camp Name">
  <button onclick="addNewCamp()">Add Camp</button>
  <button onclick="deleteCamp()">Delete Camp</button>

  <h4>ğŸ“¤ Export / ğŸ“¥ Import Workers</h4>
  <button onclick="exportCSV()">Export Workers CSV</button><br><br>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="importCSV()">Import CSV</button>
  <p style="font-size:12px;color:gray">
    CSV Format: iq,name,camp,company,gender,nationality,sponsor,room
  </p>

  <h4>ğŸ”‘ Master Controls</h4>
  <label>Master Password:
    <input type="password" id="masterPw" placeholder="Enter Master Password">
  </label>
  <button onclick="verifyMaster()">Verify</button>
  <div id="masterMsg" style="color:green;margin-top:5px;font-weight:600;"></div>

  <div id="masterControls" class="hidden" style="margin-top:8px;">
    <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">â• Add Column</button>
    <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ—‘ Delete Column</button>
    <button onclick="saveWorkerColumns()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ’¾ Save Changes</button>
    <!-- new delete all -->
    <button onclick="deleteFullAccommodation()" style="margin:5px;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;">âš ï¸ Delete Full Accommodation</button>
  </div>
</div>

<h2>ğŸ•ï¸ Select Camp</h2>
<div style="margin:10px 0;">
  <label>Camp:
    <select id="campSelect" onchange="showSelectedCamp()"></select>
  </label>
  <button onclick="showSelectedCamp()">Show Camp</button>
</div>

<div class="search-box">
  <h3>ğŸ” Search Worker by IQAMA</h3>
  <input type="text" id="searchIqama" placeholder="Enter IQAMA Number">
  <button onclick="searchByIqama()">Search</button>
  <div id="searchResult" style="margin-top:10px;"></div>
</div>

<div class="summary-chart" style="margin-top:12px;">
  <div id="clientSummaryBox" class="box">
    <h2>ğŸ¢ Client / Company Summary</h2>
    <div id="clientSummary"></div>
  </div>
  <div id="clientChartBox" class="box">
    <h2>ğŸ“Š Worker Count Graph</h2>
    <canvas id="clientChart" height="300"></canvas>
  </div>
</div>

<h2>ğŸ˜ï¸ Camp Summary</h2>
<div id="campSummary"></div>

<h2>ğŸ‘· Worker Details</h2>
<div id="tableWrap"></div>

<div id="workerColumnControls" class="hidden" style="margin-top:8px;">
  <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">â• Add Column</button>
  <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ—‘ Delete Column</button>
  <button onclick="saveWorkerColumns()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ’¾ Save Changes</button>
</div>

<div class="footer">Made with â¤ï¸ by <span>Faizan Khan</span></div>

<script>
/* --- PART 2 (JavaScript logic) will start below --- *//* ==========================================================
   CARE-PRO MAIN JAVASCRIPT  (Part 2 of 3)
   ========================================================== */

let allData = { workers: [], camps: [], campData: {} };
let adminLogged = false;
let masterVerified = false;
let workerColumns = ["iq", "name", "camp", "company", "gender", "nationality", "sponsor", "room"];
let currentCamp = "";
let clientChart = null;

/* -------------------- API COMMUNICATION ------------------- */
async function loadData() {
  try {
    const r = await fetch("/api/saveData");
    const data = await r.json();
    allData = data || { workers: [], camps: [], campData: {} };
    console.log("Data loaded:", allData);
    refreshCampSelect();
    refreshSummary();
  } catch (e) {
    console.error("Load error", e);
  }
}

async function saveData() {
  try {
    const r = await fetch("/api/saveData", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(allData)
    });
    const res = await r.json();
    showMsg("âœ… Data saved to GitHub!");
    console.log(res);
  } catch (e) {
    console.error("Save error", e);
    showMsg("âŒ Failed to save data!");
  }
}

/* -------------------- LOGIN HANDLERS ---------------------- */
function login() {
  const pw = document.getElementById("adminPw").value.trim();
  if (pw === "12341234") {
    adminLogged = true;
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("adminBox").classList.remove("hidden");
    document.getElementById("editor").classList.remove("hidden");
    showMsg("Welcome Admin!");
  } else {
    alert("Wrong password!");
  }
}
function logout() {
  adminLogged = false;
  masterVerified = false;
  document.getElementById("loginBox").classList.remove("hidden");
  document.getElementById("adminBox").classList.add("hidden");
  document.getElementById("editor").classList.add("hidden");
  document.getElementById("masterControls").classList.add("hidden");
}

/* -------------------- BASIC UTILITIES --------------------- */
function showMsg(msg) {
  const el = document.getElementById("msg");
  el.textContent = msg;
  el.style.opacity = 1;
  setTimeout(() => (el.style.opacity = 0), 2500);
}

/* -------------------- WORKER MANAGEMENT ------------------- */
function addWorker() {
  if (!adminLogged) return alert("Login required!");
  const w = {
    iq: f_iq.value.trim(),
    name: f_name.value.trim(),
    camp: f_camp.value.trim(),
    company: f_company.value.trim(),
    gender: f_gender.value.trim(),
    nationality: f_nationality.value.trim(),
    sponsor: f_sponsor.value.trim(),
    room: f_room.value.trim()
  };
  if (!w.iq) return alert("IQAMA required!");
  allData.workers.push(w);
  saveData();
  refreshSummary();
  showMsg("Worker added!");
}

function deleteWorkerPrompt() {
  const iq = prompt("Enter IQAMA to delete:");
  if (!iq) return;
  const before = allData.workers.length;
  allData.workers = allData.workers.filter(w => w.iq !== iq);
  if (allData.workers.length < before) {
    saveData();
    refreshSummary();
    showMsg("Worker deleted!");
  } else alert("IQAMA not found!");
}

/* -------------------- CAMP MANAGEMENT --------------------- */
function addNewCamp() {
  const name = newCampName.value.trim();
  if (!name) return alert("Enter camp name!");
  if (!allData.camps.includes(name)) {
    allData.camps.push(name);
    allData.campData[name] = { workers: 0 };
    saveData();
    refreshCampSelect();
    showMsg("Camp added!");
  } else alert("Camp exists!");
}
function deleteCamp() {
  const name = prompt("Enter camp name to delete:");
  if (!name) return;
  if (!allData.camps.includes(name)) return alert("Camp not found!");
  if (!confirm(`Delete camp ${name}?`)) return;
  allData.camps = allData.camps.filter(c => c !== name);
  allData.workers = allData.workers.filter(w => w.camp !== name);
  delete allData.campData[name];
  saveData();
  refreshCampSelect();
  refreshSummary();
  showMsg("Camp deleted!");
}
function refreshCampSelect() {
  const sel = document.getElementById("campSelect");
  sel.innerHTML = "";
  allData.camps.forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    sel.appendChild(o);
  });
  if (allData.camps.length) currentCamp = allData.camps[0];
}

/* -------------------- DISPLAY FUNCTIONS ------------------- */
function showSelectedCamp() {
  const sel = document.getElementById("campSelect");
  currentCamp = sel.value;
  const list = allData.workers.filter(w => w.camp === currentCamp);
  renderTable(list);
}
function renderTable(list) {
  const wrap = document.getElementById("tableWrap");
  if (!list.length) {
    wrap.innerHTML = "<p>No workers in this camp.</p>";
    return;
  }
  let html = "<table><tr>";
  workerColumns.forEach(c => (html += `<th>${c.toUpperCase()}</th>`));
  html += "</tr>";
  list.forEach(w => {
    html += "<tr>";
    workerColumns.forEach(c => (html += `<td>${w[c] || ""}</td>`));
    html += "</tr>";
  });
  html += "</table>";
  wrap.innerHTML = html;
}

/* -------------------- SEARCH BY IQAMA --------------------- */
function searchByIqama() {
  const iq = document.getElementById("searchIqama").value.trim();
  const res = allData.workers.find(w => w.iq === iq);
  const box = document.getElementById("searchResult");
  if (res) {
    box.innerHTML = `<b>${res.name}</b> â€“ ${res.company}, Camp: ${res.camp}`;
  } else box.textContent = "No worker found!";
}

/* -------------------- CSV IMPORT/EXPORT ------------------- */
function exportCSV() {
  let csv = workerColumns.join(",") + "\n";
  allData.workers.forEach(w => {
    csv += workerColumns.map(c => `"${w[c] || ""}"`).join(",") + "\n";
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "workers.csv";
  a.click();
}
function importCSV() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Select CSV!");
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split(/\r?\n/).filter(x => x);
    const cols = lines[0].split(",");
    lines.slice(1).forEach(l => {
      const vals = l.split(",");
      const w = {};
      cols.forEach((c, i) => (w[c.trim()] = vals[i]?.replace(/"/g, "").trim()));
      if (w.iq) allData.workers.push(w);
    });
    saveData();
    refreshSummary();
    showMsg("CSV imported!");
  };
  reader.readAsText(file);
}

/* -------------------- SUMMARY & CHART --------------------- */
function refreshSummary() {
  const campCounts = {};
  const clientCounts = {};
  allData.workers.forEach(w => {
    campCounts[w.camp] = (campCounts[w.camp] || 0) + 1;
    clientCounts[w.company] = (clientCounts[w.company] || 0) + 1;
  });

  // Camp summary
  const cs = document.getElementById("campSummary");
  let html = "<table><tr><th>Camp</th><th>Workers</th></tr>";
  Object.entries(campCounts).forEach(([k, v]) => (html += `<tr><td>${k}</td><td>${v}</td></tr>`));
  html += "</table>";
  cs.innerHTML = html;

  // Client summary
  const cl = document.getElementById("clientSummary");
  let chtml = "<table><tr><th>Client/Company</th><th>Workers</th></tr>";
  Object.entries(clientCounts).forEach(([k, v]) => (chtml += `<tr><td>${k}</td><td>${v}</td></tr>`));
  chtml += "</table>";
  cl.innerHTML = chtml;

  // Chart
  const ctx = document.getElementById("clientChart").getContext("2d");
  if (clientChart) clientChart.destroy();
  clientChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(clientCounts),
      datasets: [{ label: "Workers", data: Object.values(clientCounts) }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}
/* ==========================================================
   CARE-PRO MASTER CONTROLS & FINAL INIT  (Part 3 of 3)
   ========================================================== */

/* -------------------- MASTER PASSWORD -------------------- */
function verifyMaster() {
  const pw = document.getElementById("masterPw").value.trim();
  const msg = document.getElementById("masterMsg");
  if (pw === "Care@12345") {
    masterVerified = true;
    document.getElementById("masterControls").classList.remove("hidden");
    msg.textContent = "âœ… Master verified";
  } else {
    msg.textContent = "âŒ Wrong password!";
  }
}

/* -------------------- DELETE FULL ACCOMMODATION ---------- */
async function deleteFullAccommodation() {
  if (!masterVerified) return alert("Master password required!");
  if (!confirm("âš ï¸ This will permanently delete all accommodation data.\nAre you sure?")) return;

  // Wipe local data
  allData = { workers: [], camps: [], campData: {} };

  // Save immediately to GitHub
  try {
    const r = await fetch("/api/saveData", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(allData)
    });
    if (!r.ok) throw new Error("GitHub save failed");
    document.getElementById("msg").textContent = "âœ… All accommodation data deleted!";
    refreshCampSelect();
    refreshSummary();
  } catch (err) {
    console.error(err);
    alert("âŒ Delete failed: " + err.message);
  }
}

/* -------------------- WORKER COLUMN MANAGEMENT ----------- */
function addCustomWorkerColumn() {
  const col = document.getElementById("newWorkerColName").value.trim();
  if (!col) return alert("Enter column name!");
  if (workerColumns.includes(col)) return alert("Column exists!");
  workerColumns.push(col);
  document.getElementById("newColMsg").textContent = `Added column '${col}'`;
  renderTable(allData.workers.filter(w => w.camp === currentCamp));
}
function addWorkerColumn() {
  const col = prompt("Enter column name:");
  if (!col) return;
  if (workerColumns.includes(col)) return alert("Column exists!");
  workerColumns.push(col);
  renderTable(allData.workers.filter(w => w.camp === currentCamp));
}
function deleteWorkerColumn() {
  const col = prompt("Enter column name to delete:");
  if (!col) return;
  if (!workerColumns.includes(col)) return alert("Column not found!");
  workerColumns = workerColumns.filter(c => c !== col);
  renderTable(allData.workers.filter(w => w.camp === currentCamp));
}
function saveWorkerColumns() {
  localStorage.setItem("workerColumns", JSON.stringify(workerColumns));
  showMsg("Columns saved!");
}

/* -------------------- PAGE INITIALIZATION ---------------- */
window.addEventListener("load", () => {
  const savedCols = localStorage.getItem("workerColumns");
  if (savedCols) workerColumns = JSON.parse(savedCols);
  loadData();
});
</script>
</body>
</html>
