<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Care-Pro Riyadh Accommodation</title>
<style>
  body { font-family: "Poppins", Arial, sans-serif; margin: 20px; background: linear-gradient(135deg,#f8f9fa,#e9ecef); color:#222; }
  h1 { text-align:center; color:#004085; font-size:28px; margin-bottom:15px;}
  table{border-collapse:collapse;width:100%;margin:15px 0;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  th,td{border:1px solid #ddd;padding:8px 10px;text-align:left;font-size:14px;position:relative;}
  th{background:#004085;color:#fff;text-transform:uppercase;cursor:pointer;}
  tr:nth-child(even){background:#f8f9fa}
  .form{border:1px solid #ccc;padding:12px;background:#fff;border-radius:8px;margin-top:10px}
  .form input{margin:5px;padding:6px 10px;border:1px solid #bbb;border-radius:4px}
  .form button{background:#004085;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin:5px}
  .hidden{display:none}
  .footer{text-align:center;margin-top:30px;color:#555;font-style:italic}
  .dropdown { display:none; position:absolute; background:#fff; border:1px solid #ccc; border-radius:4px; top:100%; left:0; z-index:10; padding:5px; max-height:200px; overflow:auto; width:150px; box-shadow:0 2px 6px rgba(0,0,0,.1);}
  .dropdown label { display:block; font-size:13px; cursor:pointer; margin:3px 0; }
  .filter-arrow::after { content:"â–¼"; font-size:10px; margin-left:6px; color:#fff; }
  @media (max-width:768px){table,th,td{font-size:12px}.form input,button{width:100%;display:block}}
  .summary-chart { display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
  .summary-chart > .box { flex:1; min-width:300px; background:transparent; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ğŸ  CARE-PRO ACCOMMODATION</h1>

<div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
  <span id="loginBox">
    <input type="password" id="adminPw" placeholder="Enter Admin Password">
    <button onclick="login()">Login</button>
  </span>
  <span id="adminBox" class="hidden"><button onclick="logout()">Logout</button></span>
  <a href="https://linux-aios.github.io/care-pro-cv-generator-by-faizan/" target="_blank">
    <button style="background:#198754;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">
      Make CV
    </button>
  </a>
</div>

<div id="editor" class="form hidden">
  <h4>ğŸ”§ ADMIN PANEL</h4>

  <h4>â• Add Worker Fields</h4>
  <label>Field Name: <input type="text" id="newWorkerColName" placeholder="Enter new field (e.g. Mobile, Entry Date)"></label>
  <button onclick="addCustomWorkerColumn()">Add Field</button>
  <div id="newColMsg" style="color:green;margin-top:5px;font-weight:600;"></div>

  <label>IQAMA: <input id="f_iq"></label>
  <label>Name: <input id="f_name"></label>
  <label>Camp: <input id="f_camp" placeholder="CP 1 / CP 2 / CP 3"></label>
  <label>Company: <input id="f_company"></label>
  <label>Gender: <input id="f_gender"></label>
  <label>Nationality: <input id="f_nationality"></label>
  <label>Sponsor: <input id="f_sponsor"></label>
  <label>Room No: <input id="f_room"></label><br>
  <button onclick="addWorker()">Add Worker</button>
  <button onclick="deleteWorkerPrompt()">Delete by IQAMA</button>
  <div id="msg" style="color:green;margin-top:8px;font-weight:600;"></div>

  <h4>ğŸ•ï¸ Manage Camps</h4>
  <input id="newCampName" placeholder="Enter Camp Name">
  <button onclick="addNewCamp()">Add Camp</button>
  <button onclick="deleteCamp()">Delete Camp</button>
  <button onclick="deleteAccommodation()" style="background:#dc3545;color:#fff;">âŒ Delete Full Accommodation</button>

  <h4>ğŸ“¤ Export / ğŸ“¥ Import Workers</h4>
  <button onclick="exportCSV()">Export Workers CSV</button><br><br>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="importCSV()">Import CSV</button>
  <p style="font-size:12px;color:gray">CSV Format: iq,name,camp,company,gender,nationality,sponsor,room</p>

  <h4>ğŸ”‘ Master Controls</h4>
  <label>Master Password: <input type="password" id="masterPw" placeholder="Enter Master Password"></label>
  <button onclick="verifyMaster()">Verify</button>
  <div id="masterMsg" style="color:green;margin-top:5px;font-weight:600;"></div>

  <div id="masterControls" class="hidden" style="margin-top:8px;">
    <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">â• Add Column</button>
    <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ—‘ Delete Column</button>
    <button onclick="saveWorkerColumns()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ’¾ Save Changes</button>
  </div>
</div>

<h2>ğŸ•ï¸ Select Camp</h2>
<div style="margin:10px 0;">
  <label>Camp: <select id="campSelect" onchange="showSelectedCamp()"></select></label>
  <button onclick="showSelectedCamp()">Show Camp</button>
</div>

<div class="search-box">
  <h3>ğŸ” Search Worker by IQAMA</h3>
  <input type="text" id="searchIqama" placeholder="Enter IQAMA Number">
  <button onclick="searchByIqama()">Search</button>
  <div id="searchResult" style="margin-top:10px;"></div>
</div>

<div class="summary-chart" style="margin-top:12px;">
  <div id="clientSummaryBox" class="box"><h2>ğŸ¢ Client / Company Summary</h2><div id="clientSummary"></div></div>
  <div id="clientChartBox" class="box"><h2>ğŸ“Š Worker Count Graph</h2><canvas id="clientChart" height="300"></canvas></div>
</div>

<h2>ğŸ˜ï¸ Camp Summary</h2><div id="campSummary"></div>
<h2>ğŸ‘· Worker Details</h2><div id="tableWrap"></div>
<div id="workerColumnControls" class="hidden" style="margin-top:8px;">
  <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">â• Add Column</button>
  <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ—‘ Delete Column</button>
  <button onclick="saveWorkerColumns()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">ğŸ’¾ Save Changes</button>
</div>

<div class="footer">Made with â¤ï¸ by <span>Faizan Khan</span></div>

<script>
const ADMIN_PASSWORD = '12341234';
const MASTER_PASSWORD = 'Care@12345';
let isAdmin = false, workers = [], camps = [], campData = {}, activeFilters = {}, clientChartInstance = null;

// ---------- API ----------
async function apiGetData() {
  try { const r = await fetch('/api/saveData'); if(!r.ok) throw new Error(); return await r.json(); }
  catch(e){ console.error(e); return {workers:[], camps:[], campData:{}}; }
}
async function apiSaveData() {
  try { const r = await fetch('/api/saveData', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({workers,camps,campData})});
    if(!r.ok) throw new Error(); return await r.json();
  } catch(e){ console.error(e); return null; }
}

// ---------- Admin ----------
function login(){ if(adminPw.value===ADMIN_PASSWORD){isAdmin=true;editor.classList.remove('hidden');loginBox.classList.add('hidden');adminBox.classList.remove('hidden');msg.innerText='Admin mode enabled';renderAll();}else alert('âŒ Wrong password!');}
function logout(){isAdmin=false;editor.classList.add('hidden');loginBox.classList.remove('hidden');adminBox.classList.add('hidden');renderAll();}

// ---------- Workers ----------
function addWorker(){
  const w={iq:f_iq.value.trim(),name:f_name.value.trim(),camp:f_camp.value.trim(),company:f_company.value.trim(),gender:f_gender.value.trim(),nationality:f_nationality.value.trim(),sponsor:f_sponsor.value.trim(),room:f_room.value.trim()};
  if(!w.iq||!w.name) return alert("IQAMA and Name required!");
  workers.push(w); apiSaveData().then(r=>{if(r){msg.innerText="âœ… Worker added!"; renderAll();}});
}
function deleteWorkerPrompt(){
  const iq=prompt("Enter IQAMA to delete:"); if(!iq) return;
  const i=workers.findIndex(w=>w.iq===iq); if(i>=0){
    exportCSV(); workers.splice(i,1); apiSaveData().then(r=>{if(r){alert("ğŸ—‘ï¸ Worker deleted!"); renderAll();}});
  } else alert("âŒ IQAMA not found!");
}

// ---------- Camps ----------
function addNewCamp(){
  const pw=prompt("Enter Master Password to add camp:"); if(pw!==MASTER_PASSWORD) return alert("âŒ Wrong master password!");
  const name=(newCampName.value||'').trim(); if(!name) return alert('Enter camp name');
  if(!camps.includes(name)) camps.push(name);
  apiSaveData().then(r=>{if(r){alert('âœ… Camp added successfully!'); updateCampDropdown(); renderAll();}});
}
function deleteCamp(){
  const pw=prompt("Enter Master Password to delete camp:"); if(pw!==MASTER_PASSWORD) return alert("âŒ Wrong master password!");
  const name=(newCampName.value||'').trim(); if(!name) return alert('Enter camp name');
  const i=camps.indexOf(name); if(i>=0){exportCSV(); camps.splice(i,1); delete campData[name]; apiSaveData().then(r=>{if(r){alert('ğŸ—‘ï¸ Camp deleted successfully!'); updateCampDropdown(); renderAll();}});} else alert('Camp not found');
}
function deleteAccommodation(){
  const name=(newCampName.value||'').trim(); if(!name) return alert('âš ï¸ Enter camp name');
  const pw=prompt('Enter Master Password to confirm deletion:'); if(pw!==MASTER_PASSWORD) return alert('âŒ Wrong master password!');
  const related=workers.filter(w=>w.camp===name); if(related.length===0) return alert(`No data for "${name}"`);
  const h=["iq","name","camp","company","gender","nationality","sponsor","room"];
  const csv=h.join(",")+"\n"+related.map(w=>h.map(x=>`"${(w[x]||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const b=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=`${name}_backup.csv`; a.click();
  if(!confirm(`âš ï¸ Delete "${name}" and all related data?`)) return;
  workers=workers.filter(w=>w.camp!==name); const i=camps.indexOf(name); if(i>=0) camps.splice(i,1); delete campData[name];
  apiSaveData().then(r=>{if(r){alert(`âœ… "${name}" deleted with backup.`); updateCampDropdown(); renderAll();}});
}

// ---------- CSV ----------
function exportCSV(){
  if(workers.length===0) return alert("No data to export!");
  const h=["iq","name","camp","company","gender","nationality","sponsor","room"];
  const r=workers.map(w=>h.map(x=>`"${(w[x]||"").replace(/"/g,'""')}"`).join(","));
  const csv=h.join(",")+"\n"+r.join("\n");
  const b=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download="workers.csv"; a.click();
}
function importCSV(){
  const pw=prompt("Enter Master Password to import CSV:"); if(pw!==MASTER_PASSWORD) return alert("âŒ Wrong master password!");
  const f=document.getElementById("csvFile").files[0]; if(!f) return alert("Select CSV file!");
  const r=new FileReader();
  r.onload=function(e){
    const lines=e.target.result.split("\n").map(l=>l.trim()).filter(l=>l);
    const headers=lines.shift().split(",").map(h=>h.trim().replace(/"/g,""));
    const nw=lines.map(l=>{const v=l.split(",").map(x=>x.replace(/^"|"$/g,"").trim());const o={};headers.forEach((h,i)=>o[h]=v[i]||"");return o;});
    if(confirm(`Import ${nw.length} workers?`)){workers=nw;apiSaveData().then(x=>{if(x){alert("âœ… CSV Imported!");renderAll();}});}
  }; r.readAsText(f);
}

// ---------- Helpers ----------
function updateCampDropdown(){campSelect.innerHTML='';camps.forEach(c=>{const o=document.createElement('option');o.value=c;o.innerText=c;campSelect.appendChild(o);});}
function showSelectedCamp(){const s=campSelect.value; renderTable(s);}
async function loadData(){const d=await apiGetData();workers=d.workers||[];camps=d.camps||[];campData=d.campData||{};updateCampDropdown();renderAll();}
function renderAll(){updateCampDropdown();renderTable();renderClientSummary();renderCampSummary();}

// (the rest of renderTable, summaries, etc. remain unchanged from your version)

function addCustomWorkerColumn(){
  const name=document.getElementById('newWorkerColName').value.trim();
  const msg=document.getElementById('newColMsg');
  if(!name)return alert("Enter a field name!");
  const table=document.querySelector("#tableWrap table");
  if(!table)return alert("No worker table found!");
  const headerRow=table.tHead.rows[0];
  const newTh=document.createElement("th");newTh.contentEditable="true";newTh.innerText=name;headerRow.appendChild(newTh);
  for(let r=0;r<table.tBodies[0].rows.length;r++){const cell=table.tBodies[0].rows[r].insertCell();cell.contentEditable="true";cell.innerText="";}
  saveWorkerColumns(); msg.innerText=`âœ… Field "${name}" added!`; document.getElementById('newWorkerColName').value='';
}
function verifyMaster(){
  const pw=document.getElementById('masterPw').value;
  const msg=document.getElementById('masterMsg');
  const ctrl=document.getElementById('masterControls');
  if(pw===MASTER_PASSWORD){ctrl.classList.remove('hidden');msg.innerText="âœ… Master verified!";}
  else{ctrl.classList.add('hidden');msg.innerText="âŒ Wrong master password!";}
}
loadData();
</script>
</body>
</html>
