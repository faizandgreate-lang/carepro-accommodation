<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Care-Pro Riyadh Accommodation</title>
<style>
  body { font-family: "Poppins", Arial, sans-serif; margin: 20px; background: linear-gradient(135deg,#f8f9fa,#e9ecef); color:#222; }
  h1 { text-align:center; color:#004085; font-size:28px; margin-bottom:15px;}
  table{border-collapse:collapse;width:100%;margin:15px 0;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  th,td{border:1px solid #ddd;padding:8px 10px;text-align:left;font-size:14px;position:relative;}
  th{background:#004085;color:#fff;text-transform:uppercase;cursor:pointer;}
  tr:nth-child(even){background:#f8f9fa}
  .form{border:1px solid #ccc;padding:12px;background:#fff;border-radius:8px;margin-top:10px}
  .form input{margin:5px;padding:6px 10px;border:1px solid #bbb;border-radius:4px}
  .form button{background:#004085;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin:5px}
  .hidden{display:none}
  .footer{text-align:center;margin-top:30px;color:#555;font-style:italic}
  .dropdown { display:none; position:absolute; background:#fff; border:1px solid #ccc; border-radius:4px; top:100%; left:0; z-index:10; padding:5px; max-height:200px; overflow:auto; width:150px; box-shadow:0 2px 6px rgba(0,0,0,.1);}
  .dropdown label { display:block; font-size:13px; cursor:pointer; margin:3px 0; color:#000; }
  .filter-arrow::after { content:"â–¼"; font-size:10px; margin-left:6px; color:#fff; }
  @media (max-width:768px){table,th,td{font-size:12px}.form input,button{width:100%;display:block}}
  .summary-chart { display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
  .summary-chart > .box { flex:1; min-width:300px; background:transparent; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ğŸ  CARE-PRO ACCOMMODATION</h1>

<div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
  <span id="loginBox">
    <input type="text" id="loginUser" placeholder="User ID">
    <input type="password" id="loginPw" placeholder="Password">
    <button onclick="login()">Login</button>
  </span>
  
  <span id="adminBox" class="hidden">
    <button onclick="logout()">Logout</button>
  </span>
  
  <a href="https://linux-aios.github.io/care-pro-cv-generator-by-faizan/" target="_blank">
    <button style="background:#198754;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">
      Make CV
    </button>
  </a>
</div>

<div id="editor" class="form hidden">
  <h4>ğŸ”§ ADMIN PANEL</h4>

  <label>IQAMA: <input id="f_iq"></label>
  <label>Name: <input id="f_name"></label>
  <label>Camp: <input id="f_camp" placeholder="CP 1 / CP 2 / CP 3"></label>
  <label>Company: <input id="f_company"></label>
  <label>Gender: <input id="f_gender"></label>
  <label>Nationality: <input id="f_nationality"></label>
  <label>Sponsor: <input id="f_sponsor"></label>
  <label>Room No: <input id="f_room"></label>
  <br>
  <button onclick="addWorker()">Add Worker</button>
  <button onclick="deleteWorkerPrompt()">Delete by IQAMA</button>
  <div id="msg" style="color:green;margin-top:8px;font-weight:600;"></div>

  <h4>ğŸ“¤ Export Workers</h4>
  <button onclick="exportCSV()">Export Workers CSV</button>

  <div id="masterHiddenSection" class="hidden" style="margin-top:20px;">
    <h4>ğŸ•ï¸ Manage Camps</h4>
    <input id="newCampName" placeholder="Enter Camp Name">
    <button onclick="addNewCamp()">Add Camp</button>
    <button onclick="deleteCamp()">Delete Camp</button>

    <h4>ğŸ“¥ Import Workers</h4>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="importCSV()">Import CSV</button>
  </div>

  <h4>ğŸ”‘ Master Controls</h4>
  <label>Master Password:
    <input type="password" id="masterPw" placeholder="Enter Master Password">
  </label>
  <button onclick="verifyMaster()">Verify</button>
  <div id="masterMsg" style="color:green;margin-top:5px;font-weight:600;"></div>
</div>

<h2>ğŸ•ï¸ Select Camp</h2>
<div style="margin:10px 0;">
  <label>Camp:
    <select id="campSelect" onchange="showSelectedCamp()"></select>
  </label>
  <button onclick="showSelectedCamp()">Show Camp</button>
</div>

<h3>ğŸ” Search Worker by IQAMA</h3>
<input type="text" id="searchIqama" placeholder="Enter IQAMA Number">
<button onclick="searchByIqama()">Search</button>
<div id="searchResult" style="margin-top:10px;"></div>

<div class="summary-chart" style="margin-top:12px;">
  <div id="clientSummaryBox" class="box">
    <h2>ğŸ¢ Client / Company Summary</h2>
    <div id="clientSummary"></div>
  </div>
  <div id="clientChartBox" class="box">
    <h2>ğŸ“Š Worker Count Graph</h2>
    <canvas id="clientChart" height="300"></canvas>
  </div>
</div>

<h2>ğŸ˜ï¸ Camp Summary</h2>
<div id="campSummary"></div>

<h2>ğŸ‘· Worker Details</h2>
<div id="tableWrap"></div>

<div class="footer">Made with â¤ï¸ by <span>Faizan Khan</span></div>
<script>
const MASTER_ID = "CPF";
const MASTER_PASS = "Care@12345";

const CAMP_USERS = {
  "New bawadi": { user: "bawadi1", pass: "1234" },
  "CP 1": { user: "cp1", pass: "cp1pass" },
  "CP 2": { user: "cp2", pass: "cp2pass" },
  "CP 3": { user: "cp3", pass: "cp3pass" }
};

let isAdmin = false;
let currentUserCamp = null;
let workers = [];
let camps = [];
let campData = {};
let activeFilters = {};
let clientChartInstance = null;

async function apiGetData() {
  try {
    const r = await fetch('/api/saveData');
    if (!r.ok) throw new Error();
    return await r.json();
  } catch {
    return { workers: [], camps: [], campData: {} };
  }
}

async function apiSaveData() {
  try {
    const r = await fetch('/api/saveData', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ workers, camps, campData })
    });
    return await r.json();
  } catch {
    alert('âš ï¸ Save error');
    return null;
  }
}

function login() {
  const user = loginUser.value.trim();
  const pw = loginPw.value.trim();

  // MASTER LOGIN
  if (user === MASTER_ID && pw === MASTER_PASS) {
    isAdmin = true;
    currentUserCamp = "MASTER";
    editor.classList.remove("hidden");
    loginBox.classList.add("hidden");
    adminBox.classList.remove("hidden");
    msg.innerText = "âœ… Master Admin mode enabled (Full Control)";
    document.getElementById("masterHiddenSection").classList.remove("hidden");
    renderAll();
    return;
  }

  // CAMP USERS LOGIN
  for (const camp in CAMP_USERS) {
    const creds = CAMP_USERS[camp];
    if (creds.user === user && creds.pass === pw) {
      isAdmin = false;
      currentUserCamp = camp;
      editor.classList.remove("hidden");
      loginBox.classList.add("hidden");
      adminBox.classList.remove("hidden");
      msg.innerText = `âœ… Logged in as Camp User (${camp})`;
      document.getElementById("masterHiddenSection").classList.add("hidden");
      renderAll();
      return;
    }
  }

  alert("âŒ Wrong User ID or Password!");
}

function logout() {
  isAdmin = false;
  currentUserCamp = null;
  editor.classList.add("hidden");
  loginBox.classList.remove("hidden");
  adminBox.classList.add("hidden");
  renderAll();
}

function addWorker() {
  const w = {
    iq: f_iq.value.trim(),
    name: f_name.value.trim(),
    camp: f_camp.value.trim(),
    company: f_company.value.trim(),
    gender: f_gender.value.trim(),
    nationality: f_nationality.value.trim(),
    sponsor: f_sponsor.value.trim(),
    room: f_room.value.trim()
  };
  if (!w.iq || !w.name) return alert("IQAMA and Name required!");

  if (!isAdmin && currentUserCamp && w.camp !== currentUserCamp)
    return alert(`âŒ You can only add workers to your own camp: ${currentUserCamp}`);

  workers.push(w);
  apiSaveData().then(r => { if (r) renderAll(); });
}

function deleteWorkerPrompt() {
  const iq = prompt("Enter IQAMA to delete:");
  if (!iq) return;
  const i = workers.findIndex(w => w.iq === iq);
  if (i < 0) return alert("Not found!");
  const w = workers[i];
  if (!isAdmin && w.camp !== currentUserCamp)
    return alert(`âŒ Only delete from your camp: ${currentUserCamp}`);
  if (confirm(`Delete ${w.name}?`)) {
    workers.splice(i, 1);
    apiSaveData().then(r => { if (r) renderAll(); });
  }
}
function verifyMaster() {
  const pw = masterPw.value.trim();
  const msg = masterMsg;
  if (pw === MASTER_PASS) {
    isAdmin = true;
    currentUserCamp = "MASTER";
    document.getElementById("masterHiddenSection").classList.remove("hidden");
    msg.innerText = "âœ… Master verified. Full control unlocked.";
    renderAll();
  } else {
    msg.innerText = "âŒ Wrong master password.";
  }
}

// Simple versions of these â€” keep your originals if needed
function renderAll() { renderTable(); }
function renderTable() {
  let html = `<table><thead><tr><th>#</th><th>IQAMA</th><th>Name</th><th>Camp</th><th>Company</th><th>Gender</th><th>Nationality</th><th>Sponsor</th><th>Room</th></tr></thead><tbody>`;
  let count = 1;
  workers.forEach(w => html += `<tr><td>${count++}</td><td>${w.iq}</td><td>${w.name}</td><td>${w.camp}</td><td>${w.company}</td><td>${w.gender}</td><td>${w.nationality}</td><td>${w.sponsor}</td><td>${w.room}</td></tr>`);
  html += `</tbody></table>`;
  tableWrap.innerHTML = html;
}

function searchByIqama() {
  const q = searchIqama.value.trim();
  const f = workers.find(w => w.iq === q);
  searchResult.innerText = f ? `${f.name} â€” ${f.camp} â€” ${f.company}` : "Not found";
}

async function loadData() {
  const d = await apiGetData();
  workers = d.workers || [];
  camps = d.camps || [];
  campData = d.campData || {};
  renderAll();
}
loadData();
</script>
</body>
</html>

